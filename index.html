/**
 * Backend Kas Driver Helper Delta 8 - SAFETY VERSION
 * ID Spreadsheet: 10GWGUs4ILzb1Hb3tm3OFy_dcRXCQKHqSQ0zPa3YmfpY
 */

const SPREADSHEET_ID = '10GWGUs4ILzb1Hb3tm3OFy_dcRXCQKHqSQ0zPa3YmfpY';

function getSS() {
  try {
    return SpreadsheetApp.openById(SPREADSHEET_ID);
  } catch (e) {
    return SpreadsheetApp.getActiveSpreadsheet();
  }
}

function doGet(e) {
  const scriptProperties = PropertiesService.getScriptProperties();
  const data = scriptProperties.getProperty('KAS_DELTA8_DB_FINAL');
  return ContentService.createTextOutput(data || JSON.stringify({driver:[], helper:[], transaksi:[], logs:[]}))
    .setMimeType(ContentService.MimeType.JSON);
}

function doPost(e) {
  const ss = getSS();
  if (!ss) return ContentService.createTextOutput("Error: SS Not Found").setMimeType(ContentService.TEXT);
  
  try {
    const contents = e.postData.contents;
    if (!contents) return ContentService.createTextOutput("Error: No Data").setMimeType(ContentService.TEXT);
    
    const data = JSON.parse(contents);
    PropertiesService.getScriptProperties().setProperty('KAS_DELTA8_DB_FINAL', contents);
    
    const d = new Date();
    const yyyy = d.getFullYear();
    const monthNames = ["", "JAN", "FEB", "MAR", "APR", "MEI", "JUN", "JUL", "AGU", "SEP", "OKT", "NOV", "DES"];
    const currentMonth = monthNames[d.getMonth() + 1];

    // PROSES DENGAN VALIDASI (Hanya update jika ada data)
    if (data.driver) processMemberSheet(ss, "DB_DRIVER", data.driver, yyyy);
    if (data.helper) processMemberSheet(ss, "DB_HELPER", data.helper, yyyy);
    if (data.transaksi) processTransactionSheet(ss, "DB_TRANSAKSI", data.transaksi);

    // Log Bulanan
    const logSheetName = "LOG_" + currentMonth + "_" + yyyy;
    let sLogs = ss.getSheetByName(logSheetName) || ss.insertSheet(logSheetName);
    if (sLogs && data.logs && data.logs.length > 0) {
       const l = data.logs[0];
       if (sLogs.getLastRow() === 0) {
         sLogs.appendRow(["WAKTU", "EDITOR", "AKSI", "KETERANGAN"]);
       }
       sLogs.appendRow([l.time, l.editor, l.aksi, l.ket]);
    }

    return ContentService.createTextOutput("✓ Berhasil").setMimeType(ContentService.TEXT);
  } catch (err) { 
    return ContentService.createTextOutput("X Gagal: " + err.message).setMimeType(ContentService.TEXT); 
  }
}

function processMemberSheet(ss, name, list, yyyy) {
  if (!list || list.length === 0) return; // JANGAN HAPUS JIKA DATA KOSONG
  
  let sheet = ss.getSheetByName(name) || ss.insertSheet(name);
  sheet.clear(); // Sekarang aman menghapus karena sudah pasti ada data pengganti
  
  applyLightLuxuryTheme(sheet);
  addMainTitle(sheet, 16);
  sheet.getRange(2, 1, 1, 14).setValues([["NO", "NAMA ANGGOTA", "JAN", "FEB", "MAR", "APR", "MEI", "JUN", "JUL", "AGU", "SEP", "OKT", "NOV", "DES"]]);
  
  const rows = list.map((item, i) => {
    let lunas = 0; let s = item.status?.[yyyy] || {};
    const row = [i + 1, item.nama];
    for (let m = 1; m <= 12; m++) { if (s[m]) { lunas++; row.push("✅"); } else { row.push("❌"); } }
    row.push(lunas); row.push(12 - lunas);
    return row;
  });
  
  sheet.getRange(3, 1, rows.length, 16).setValues(rows);
  formatHeaderLuxury(sheet, 2, 16);
  sheet.setColumnWidth(2, 200);
}

function processTransactionSheet(ss, name, list) {
  if (!list || list.length === 0) return; // JANGAN HAPUS JIKA DATA KOSONG
  
  let sheet = ss.getSheetByName(name) || ss.insertSheet(name);
  sheet.clear();
  
  applyLightLuxuryTheme(sheet);
  addMainTitle(sheet, 7);
  sheet.getRange(2, 1, 1, 7).setValues([["WAKTU", "TIPE", "PENERIMA/SUMBER", "KETERANGAN", "NOMINAL", "SALDO", "EDITOR"]]);
  
  let currentSaldo = 0;
  const rows = list.map(item => {
    const nominal = Number(item.v || item.jumlah) || 0;
    const tipe = (item.tp || "").toUpperCase().includes("MASUK") ? "PEMASUKAN" : "PENGELUARAN";
    currentSaldo += (tipe === "PEMASUKAN" ? nominal : -nominal);
    return [item.d || "-", tipe, item.p || "-", item.k || "-", nominal, currentSaldo, item.editor || "ADMIN"];
  });
  
  sheet.getRange(3, 1, rows.length, 7).setValues(rows);
  sheet.getRange(3, 5, rows.length, 2).setNumberFormat("#,##0");
  formatHeaderLuxury(sheet, 2, 7);
}

function formatHeaderLuxury(sheet, row, cols) {
  sheet.getRange(row, 1, 1, cols).setBackground("#d4af37").setFontColor("#ffffff").setFontWeight("bold");
}

function addMainTitle(sheet, lastCol) {
  sheet.getRange(1, 1, 1, lastCol).merge().setValue("DATA KAS DELTA 8").setFontWeight("bold").setHorizontalAlignment("center");
}

function applyLightLuxuryTheme(sheet) {
  sheet.getRange(1, 1, 500, 20).setFontFamily("Arial").setVerticalAlignment("middle");
}

